<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Feature Engineering | Chan`s Jupyter</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Feature Engineering" />
<meta name="author" content="Chanseok Kang" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="You will now get exposure to different types of features. You will modify existing features and create new ones. Also, you will treat the missing data accordingly. This is the Summary of lecture “Winning a Kaggle Competition in Python”, via datacamp." />
<meta property="og:description" content="You will now get exposure to different types of features. You will modify existing features and create new ones. Also, you will treat the missing data accordingly. This is the Summary of lecture “Winning a Kaggle Competition in Python”, via datacamp." />
<link rel="canonical" href="https://goodboychan.github.io/chans_jupyter/python/datacamp/kaggle/machine_learning/2020/08/12/03-Feature-Engineering.html" />
<meta property="og:url" content="https://goodboychan.github.io/chans_jupyter/python/datacamp/kaggle/machine_learning/2020/08/12/03-Feature-Engineering.html" />
<meta property="og:site_name" content="Chan`s Jupyter" />
<meta property="og:image" content="https://goodboychan.github.io/chans_jupyter/images/feature_engineering.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-12T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://goodboychan.github.io/chans_jupyter/python/datacamp/kaggle/machine_learning/2020/08/12/03-Feature-Engineering.html","@type":"BlogPosting","headline":"Feature Engineering","dateModified":"2020-08-12T00:00:00-05:00","datePublished":"2020-08-12T00:00:00-05:00","image":"https://goodboychan.github.io/chans_jupyter/images/feature_engineering.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://goodboychan.github.io/chans_jupyter/python/datacamp/kaggle/machine_learning/2020/08/12/03-Feature-Engineering.html"},"author":{"@type":"Person","name":"Chanseok Kang"},"description":"You will now get exposure to different types of features. You will modify existing features and create new ones. Also, you will treat the missing data accordingly. This is the Summary of lecture “Winning a Kaggle Competition in Python”, via datacamp.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/chans_jupyter/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://goodboychan.github.io/chans_jupyter/feed.xml" title="Chan`s Jupyter" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-33905785-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/chans_jupyter/images/favicon.ico"><link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/chans_jupyter/">Chan`s Jupyter</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/chans_jupyter/about/">About Me</a><a class="page-link" href="/chans_jupyter/search/">Search</a><a class="page-link" href="/chans_jupyter/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Feature Engineering</h1><p class="page-description">You will now get exposure to different types of features. You will modify existing features and create new ones. Also, you will treat the missing data accordingly. This is the Summary of lecture "Winning a Kaggle Competition in Python", via datacamp.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-08-12T00:00:00-05:00" itemprop="datePublished">
        Aug 12, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Chanseok Kang</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      10 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/chans_jupyter/categories/#Python">Python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/chans_jupyter/categories/#Datacamp">Datacamp</a>
        &nbsp;
      
        <a class="category-tags-link" href="/chans_jupyter/categories/#Kaggle">Kaggle</a>
        &nbsp;
      
        <a class="category-tags-link" href="/chans_jupyter/categories/#Machine_Learning">Machine_Learning</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/goodboychan/chans_jupyter/tree/main/_notebooks/2020-08-12-03-Feature-Engineering.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/chans_jupyter/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/goodboychan/chans_jupyter/main?filepath=_notebooks%2F2020-08-12-03-Feature-Engineering.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/chans_jupyter/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/goodboychan/chans_jupyter/blob/main/_notebooks/2020-08-12-03-Feature-Engineering.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/chans_jupyter/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Feature-Engineering">Feature Engineering </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Arithmetical-features">Arithmetical features </a></li>
<li class="toc-entry toc-h3"><a href="#Date-features">Date features </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Categorical-features">Categorical features </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Label-encoding">Label encoding </a></li>
<li class="toc-entry toc-h3"><a href="#One-Hot-encoding">One-Hot encoding </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Target-Encoding">Target Encoding </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Mean-target-encoding">Mean target encoding </a></li>
<li class="toc-entry toc-h3"><a href="#K-fold-cross-validation">K-fold cross-validation </a></li>
<li class="toc-entry toc-h3"><a href="#Beyond-binary-classification">Beyond binary classification </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Missing-Data">Missing Data </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Find-missing-data">Find missing data </a></li>
<li class="toc-entry toc-h3"><a href="#Impute-missing-data">Impute missing data </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-08-12-03-Feature-Engineering.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">'ggplot'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Feature-Engineering">
<a class="anchor" href="#Feature-Engineering" aria-hidden="true"><span class="octicon octicon-link"></span></a>Feature Engineering<a class="anchor-link" href="#Feature-Engineering"> </a>
</h2>
<ul>
<li>Solution workflow
<img src="/chans_jupyter/images/copied_from_nb/image/solution_workflow.png" alt="solution">
</li>
<li>Modeling Stage
<img src="/chans_jupyter/images/copied_from_nb/image/modeling_stage.png" alt="modeling">
</li>
<li>Feature Engineering
<img src="/chans_jupyter/images/copied_from_nb/image/feature_engineering.png" alt="fe">
</li>
<li>Feature types<ul>
<li>Numerical</li>
<li>Categorical</li>
<li>Datetime</li>
<li>Coordinates</li>
<li>Text</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Arithmetical-features">
<a class="anchor" href="#Arithmetical-features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Arithmetical features<a class="anchor-link" href="#Arithmetical-features"> </a>
</h3>
<p>To practice creating new features, you will be working with a subsample from the Kaggle competition called "House Prices: Advanced Regression Techniques". The goal of this competition is to predict the price of the house based on its properties. It's a regression problem with Root Mean Squared Error as an evaluation metric.</p>
<p>Your goal is to create new features and determine whether they improve your validation score. To get the validation score from 5-fold cross-validation, you're given the <code>get_kfold_rmse()</code> function.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_kfold_rmse</span><span class="p">(</span><span class="n">train</span><span class="p">):</span>
    <span class="n">mse_scores</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train</span><span class="p">):</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'Id'</span><span class="p">,</span> <span class="s1">'SalePrice'</span><span class="p">,</span> <span class="s1">'RoofStyle'</span><span class="p">,</span> <span class="s1">'CentralAir'</span><span class="p">]]</span>
        
        <span class="n">fold_train</span><span class="p">,</span> <span class="n">fold_test</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

        <span class="c1"># Fit the data and make predictions</span>
        <span class="c1"># Create a Random Forest object</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

        <span class="c1"># Train a model</span>
        <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">fold_train</span><span class="p">[</span><span class="n">feats</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">fold_train</span><span class="p">[</span><span class="s1">'SalePrice'</span><span class="p">])</span>

        <span class="c1"># Get predictions for the test set</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fold_test</span><span class="p">[</span><span class="n">feats</span><span class="p">])</span>
    
        <span class="n">fold_score</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">fold_test</span><span class="p">[</span><span class="s1">'SalePrice'</span><span class="p">],</span> <span class="n">pred</span><span class="p">)</span>
        <span class="n">mse_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fold_score</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mse_scores</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mse_scores</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/house_prices_train.csv'</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/house_prices_test.csv'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'RMSE before feature engineering:'</span><span class="p">,</span> <span class="n">get_kfold_rmse</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>

<span class="c1"># Find the total area of the house</span>
<span class="n">train</span><span class="p">[</span><span class="s1">'totalArea'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">'TotalBsmtSF'</span><span class="p">]</span> <span class="o">+</span> <span class="n">train</span><span class="p">[</span><span class="s1">'1stFlrSF'</span><span class="p">]</span> <span class="o">+</span> <span class="n">train</span><span class="p">[</span><span class="s1">'2ndFlrSF'</span><span class="p">]</span>

<span class="c1"># Look at the updated RMSE</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'RMSE with total area:'</span><span class="p">,</span> <span class="n">get_kfold_rmse</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>

<span class="c1"># Find the area of the garden</span>
<span class="n">train</span><span class="p">[</span><span class="s1">'GardenArea'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">'LotArea'</span><span class="p">]</span> <span class="o">-</span> <span class="n">train</span><span class="p">[</span><span class="s1">'1stFlrSF'</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'RMSE with garden area:'</span><span class="p">,</span> <span class="n">get_kfold_rmse</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>

<span class="c1"># Find total number of bathrooms</span>
<span class="n">train</span><span class="p">[</span><span class="s1">'TotalBath'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">'FullBath'</span><span class="p">]</span> <span class="o">+</span> <span class="n">train</span><span class="p">[</span><span class="s1">'HalfBath'</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'RMSE with number of bathromms:'</span><span class="p">,</span> <span class="n">get_kfold_rmse</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>RMSE before feature engineering: 36029.39
RMSE with total area: 35073.2
RMSE with garden area: 34413.55
RMSE with number of bathromms: 34506.78
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You've created three new features. Here you see that house area improved the RMSE by almost <code>$1,000</code>. Adding garden area improved the RMSE by another <code>$600</code>. However, with the total number of bathrooms, the RMSE has increased. It means that you keep the new area features, but do not add "TotalBath" as a new feature.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Date-features">
<a class="anchor" href="#Date-features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Date features<a class="anchor-link" href="#Date-features"> </a>
</h3>
<p>You've built some basic features using numerical variables. Now, it's time to create features based on date and time. You will practice on a subsample from the Taxi Fare Prediction Kaggle competition data. The data represents information about the taxi rides and the goal is to predict the price for each ride.</p>
<p>Your objective is to generate date features from the pickup datetime. Recall that it's better to create new features for train and test data simultaneously. After the features are created, split the data back into the train and test DataFrames. Here it's done using pandas' <code>isin()</code> method.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/taxi_train_chapter_4.csv'</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/taxi_test_chapter_4.csv'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">taxi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>

<span class="c1"># Convert pickup date to datetime object</span>
<span class="n">taxi</span><span class="p">[</span><span class="s1">'pickup_datetime'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">taxi</span><span class="p">[</span><span class="s1">'pickup_datetime'</span><span class="p">])</span>

<span class="c1"># Create a day of week feature</span>
<span class="n">taxi</span><span class="p">[</span><span class="s1">'dayofweek'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi</span><span class="p">[</span><span class="s1">'pickup_datetime'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span>

<span class="c1"># Create an hour feature</span>
<span class="n">taxi</span><span class="p">[</span><span class="s1">'hour'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi</span><span class="p">[</span><span class="s1">'pickup_datetime'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>

<span class="c1"># Split back into train and test</span>
<span class="n">new_train</span> <span class="o">=</span> <span class="n">taxi</span><span class="p">[</span><span class="n">taxi</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])]</span>
<span class="n">new_test</span> <span class="o">=</span> <span class="n">taxi</span><span class="p">[</span><span class="n">taxi</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Categorical-features">
<a class="anchor" href="#Categorical-features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Categorical features<a class="anchor-link" href="#Categorical-features"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Label-encoding">
<a class="anchor" href="#Label-encoding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Label encoding<a class="anchor-link" href="#Label-encoding"> </a>
</h3>
<p>Let's work on categorical variables encoding. You will again work with a subsample from the House Prices Kaggle competition.</p>
<p>Your objective is to encode categorical features "RoofStyle" and "CentralAir" using label encoding.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/house_prices_train.csv'</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/house_prices_test.csv'</span><span class="p">)</span>

<span class="c1"># Concatenate train and test together</span>
<span class="n">houses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>

<span class="c1"># Label encoder</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

<span class="c1"># Create new features</span>
<span class="n">houses</span><span class="p">[</span><span class="s1">'RoofStyle_enc'</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">houses</span><span class="p">[</span><span class="s1">'RoofStyle'</span><span class="p">])</span>
<span class="n">houses</span><span class="p">[</span><span class="s1">'CentralAir_enc'</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">houses</span><span class="p">[</span><span class="s1">'CentralAir'</span><span class="p">])</span>

<span class="c1"># Look at new features</span>
<span class="n">houses</span><span class="p">[[</span><span class="s1">'RoofStyle'</span><span class="p">,</span> <span class="s1">'RoofStyle_enc'</span><span class="p">,</span> <span class="s1">'CentralAir'</span><span class="p">,</span> <span class="s1">'CentralAir_enc'</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RoofStyle</th>
      <th>RoofStyle_enc</th>
      <th>CentralAir</th>
      <th>CentralAir_enc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Gable</td>
      <td>1</td>
      <td>Y</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Gable</td>
      <td>1</td>
      <td>Y</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Gable</td>
      <td>1</td>
      <td>Y</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Gable</td>
      <td>1</td>
      <td>Y</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Gable</td>
      <td>1</td>
      <td>Y</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="One-Hot-encoding">
<a class="anchor" href="#One-Hot-encoding" aria-hidden="true"><span class="octicon octicon-link"></span></a>One-Hot encoding<a class="anchor-link" href="#One-Hot-encoding"> </a>
</h3>
<p>The problem with label encoding is that it implicitly assumes that there is a ranking dependency between the categories. So, let's change the encoding method for the features "RoofStyle" and "CentralAir" to one-hot encoding.</p>
<p>Recall that if you're dealing with binary features (categorical features with only two categories) it is suggested to apply label encoder only.</p>
<p>Your goal is to determine which of the mentioned features is not binary, and to apply one-hot encoding only to this one.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">houses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span>

<span class="c1"># Look at feature distributions</span>
<span class="nb">print</span><span class="p">(</span><span class="n">houses</span><span class="p">[</span><span class="s1">'RoofStyle'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">houses</span><span class="p">[</span><span class="s1">'CentralAir'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Gable      2310
Hip         551
Gambrel      22
Flat         20
Mansard      11
Shed          5
Name: RoofStyle, dtype: int64 

Y    2723
N     196
Name: CentralAir, dtype: int64
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">houses</span><span class="p">[</span><span class="s1">'CentralAir_enc'</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">houses</span><span class="p">[</span><span class="s1">'CentralAir'</span><span class="p">])</span>

<span class="c1"># Create One-Hot encoded features</span>
<span class="n">ohe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">houses</span><span class="p">[</span><span class="s1">'RoofStyle'</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">'RoofStyle'</span><span class="p">)</span>

<span class="c1"># Concatenate OHE features to houses</span>
<span class="n">houses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">houses</span><span class="p">,</span> <span class="n">ohe</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Look at OHE features</span>
<span class="n">houses</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">houses</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">'RoofStyle'</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RoofStyle</th>
      <th>RoofStyle_Flat</th>
      <th>RoofStyle_Gable</th>
      <th>RoofStyle_Gambrel</th>
      <th>RoofStyle_Hip</th>
      <th>RoofStyle_Mansard</th>
      <th>RoofStyle_Shed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Gable</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Gable</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Gable</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Gable</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Gable</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Target-Encoding">
<a class="anchor" href="#Target-Encoding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Target Encoding<a class="anchor-link" href="#Target-Encoding"> </a>
</h2>
<ul>
<li>Mean target encoding<ol>
<li>Calculate mean on the train, apply to the test</li>
<li>Split train into K folds, Calculate mean on (K-1) folds, apply to the K-th fold</li>
<li>Add mean target encoded feature to the model</li>
</ol>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Mean-target-encoding">
<a class="anchor" href="#Mean-target-encoding" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mean target encoding<a class="anchor-link" href="#Mean-target-encoding"> </a>
</h3>
<p>First of all, you will create a function that implements mean target encoding. Remember that you need to develop the two following steps:</p>
<ol>
<li>Calculate the mean on the train, apply to the test</li>
<li>Split train into K folds. Calculate the out-of-fold mean for each fold, apply to this particular fold</li>
</ol>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_mean_target_encoding</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Calculate global mean on the train data</span>
    <span class="n">global_mean</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Group by the categorical feature and calculate its properties</span>
    <span class="n">train_groups</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">categorical</span><span class="p">)</span>
    <span class="n">category_sum</span> <span class="o">=</span> <span class="n">train_groups</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">category_size</span> <span class="o">=</span> <span class="n">train_groups</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    
    <span class="c1"># Calculate smoothed mean target statistics</span>
    <span class="n">train_statistics</span> <span class="o">=</span> <span class="p">(</span><span class="n">category_sum</span> <span class="o">+</span> <span class="n">global_mean</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">category_size</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span>
    
    <span class="c1"># Apply statistics to the test data and fill new categories</span>
    <span class="n">test_feature</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">categorical</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">train_statistics</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">global_mean</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_feature</span><span class="o">.</span><span class="n">values</span>

<span class="k">def</span> <span class="nf">train_mean_target_encoding</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Create 5-fold cross-validation</span>
    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">train_feature</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float'</span><span class="p">)</span>
    
    <span class="c1"># For each folds split</span>
    <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train</span><span class="p">):</span>
        <span class="n">cv_train</span><span class="p">,</span> <span class="n">cv_test</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        
        <span class="c1"># Calculate out-of-fold statistics and apply to cv_test</span>
        <span class="n">cv_test_feature</span> <span class="o">=</span> <span class="n">test_mean_target_encoding</span><span class="p">(</span><span class="n">cv_train</span><span class="p">,</span> <span class="n">cv_test</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> 
                                                    <span class="n">categorical</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        
        <span class="c1"># Save new feature for this particular fold</span>
        <span class="n">train_feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_test_feature</span>
    <span class="k">return</span> <span class="n">train_feature</span><span class="o">.</span><span class="n">values</span>

<span class="k">def</span> <span class="nf">mean_target_encoding</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Get the train feature</span>
    <span class="n">train_feature</span> <span class="o">=</span> <span class="n">train_mean_target_encoding</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
    
    <span class="c1"># Get the test feature</span>
    <span class="n">test_feature</span> <span class="o">=</span> <span class="n">test_mean_target_encoding</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
    
    <span class="c1"># Return new features to add to the model</span>
    <span class="k">return</span> <span class="n">train_feature</span><span class="p">,</span> <span class="n">test_feature</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="K-fold-cross-validation">
<a class="anchor" href="#K-fold-cross-validation" aria-hidden="true"><span class="octicon octicon-link"></span></a>K-fold cross-validation<a class="anchor-link" href="#K-fold-cross-validation"> </a>
</h3>
<p>You will work with a binary classification problem on a subsample from Kaggle playground competition. The objective of this competition is to predict whether a famous basketball player Kobe Bryant scored a basket or missed a particular shot.</p>
<p>Train data is available in your workspace as <code>bryant_shots</code> DataFrame. It contains data on 10,000 shots with its properties and a target variable <code>"shot\_made\_flag"</code> -- whether shot was scored or not.</p>
<p>One of the features in the data is <code>"game_id"</code> -- a particular game where the shot was made. There are 541 distinct games. So, you deal with a high-cardinality categorical feature. Let's encode it using a target mean!</p>
<p>Suppose you're using 5-fold cross-validation and want to evaluate a mean target encoded feature on the local validation.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bryant_shots</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/bryant_shots.csv'</span><span class="p">)</span>

<span class="c1"># Create 5-fold cross-validation</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># For each folds split</span>
<span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">bryant_shots</span><span class="p">):</span>
    <span class="n">cv_train</span><span class="p">,</span> <span class="n">cv_test</span> <span class="o">=</span> <span class="n">bryant_shots</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">bryant_shots</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Create mean target encoded feature</span>
    <span class="n">cv_train</span><span class="p">[</span><span class="s1">'game_id_enc'</span><span class="p">],</span> <span class="n">cv_test</span><span class="p">[</span><span class="s1">'game_id_enc'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_target_encoding</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="n">cv_train</span><span class="p">,</span>
                                                                           <span class="n">test</span><span class="o">=</span><span class="n">cv_test</span><span class="p">,</span>
                                                                           <span class="n">target</span><span class="o">=</span><span class="s1">'shot_made_flag'</span><span class="p">,</span>
                                                                           <span class="n">categorical</span><span class="o">=</span><span class="s1">'game_id'</span><span class="p">,</span>
                                                                           <span class="n">alpha</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="c1"># Look at the encoding</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cv_train</span><span class="p">[[</span><span class="s1">'game_id'</span><span class="p">,</span> <span class="s1">'shot_made_flag'</span><span class="p">,</span> <span class="s1">'game_id_enc'</span><span class="p">]]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>      game_id  shot_made_flag  game_id_enc
118  20000108             1.0     0.444531
       game_id  shot_made_flag  game_id_enc
3249  20200471             0.0     0.562617
       game_id  shot_made_flag  game_id_enc
6048  20400930             0.0     0.276686
       game_id  shot_made_flag  game_id_enc
3199  20200425             0.0     0.485156
       game_id  shot_made_flag  game_id_enc
7808  20500988             0.0     0.392894
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You could see different game encodings for each validation split in the output. The main conclusion you should make: while using local cross-validation, you need to repeat mean target encoding procedure inside each folds split separately.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Beyond-binary-classification">
<a class="anchor" href="#Beyond-binary-classification" aria-hidden="true"><span class="octicon octicon-link"></span></a>Beyond binary classification<a class="anchor-link" href="#Beyond-binary-classification"> </a>
</h3>
<p>Of course, binary classification is just a single special case. Target encoding could be applied to any target variable type:</p>
<ul>
<li>For <strong>binary classification</strong> usually mean target encoding is used</li>
<li>For <strong>regression</strong> mean could be changed to median, quartiles, etc.</li>
<li>For <strong>multi-class classification</strong> with N classes we create N features with target mean for each category in one vs. all fashion
The <code>mean_target_encoding()</code> function you've created could be used for any target type specified above. Let's apply it for the regression problem on the example of House Prices Kaggle competition.</li>
</ul>
<p>Your goal is to encode a categorical feature <code>"RoofStyle"</code> using mean target encoding.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/house_prices_train.csv'</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/house_prices_test.csv'</span><span class="p">)</span>

<span class="c1"># Create mean target encoded feature</span>
<span class="n">train</span><span class="p">[</span><span class="s1">'RoofStyle_enc'</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="s1">'RoofStyle_enc'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_target_encoding</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
                                                                     <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> 
                                                                     <span class="n">target</span><span class="o">=</span><span class="s1">'SalePrice'</span><span class="p">,</span>
                                                                     <span class="n">categorical</span><span class="o">=</span><span class="s1">'RoofStyle'</span><span class="p">,</span>
                                                                     <span class="n">alpha</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># Look at the encoding</span>
<span class="n">test</span><span class="p">[[</span><span class="s1">'RoofStyle'</span><span class="p">,</span> <span class="s1">'RoofStyle_enc'</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RoofStyle</th>
      <th>RoofStyle_enc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Gable</td>
      <td>171565.947836</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hip</td>
      <td>217594.645131</td>
    </tr>
    <tr>
      <th>98</th>
      <td>Gambrel</td>
      <td>164152.950424</td>
    </tr>
    <tr>
      <th>133</th>
      <td>Flat</td>
      <td>188703.563431</td>
    </tr>
    <tr>
      <th>362</th>
      <td>Mansard</td>
      <td>180775.938759</td>
    </tr>
    <tr>
      <th>1053</th>
      <td>Shed</td>
      <td>188267.663242</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You observe that houses with the <code>Hip</code> roof are the most pricy, while houses with the <code>Gambrel</code> roof are the cheapest. It's exactly the goal of target encoding: you've encoded categorical feature in such a manner that there is now a correlation between category values and target variable. We're done with categorical encoders.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Missing-Data">
<a class="anchor" href="#Missing-Data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Missing Data<a class="anchor-link" href="#Missing-Data"> </a>
</h2>
<ul>
<li>Impute missing data<ul>
<li>Numerical data<ul>
<li>Mean/median imputation</li>
<li>Constant value imputation</li>
</ul>
</li>
<li>Categorical data<ul>
<li>Most frequent category imputation</li>
<li>New category imputation</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Find-missing-data">
<a class="anchor" href="#Find-missing-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Find missing data<a class="anchor-link" href="#Find-missing-data"> </a>
</h3>
<p>Let's impute missing data on a real Kaggle dataset. For this purpose, you will be using a data subsample from the Kaggle "Two sigma connect: rental listing inquiries" competition.</p>
<p>Before proceeding with any imputing you need to know the number of missing values for each of the features. Moreover, if the feature has missing values, you should explore the type of this feature.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">twosigma</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'./dataset/twosigma_rental_train_null.csv'</span><span class="p">)</span>

<span class="c1"># find the number of missing values in each column</span>
<span class="nb">print</span><span class="p">(</span><span class="n">twosigma</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="n">twosigma</span><span class="p">[[</span><span class="s1">'building_id'</span><span class="p">,</span> <span class="s1">'price'</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>id                 0
bathrooms          0
bedrooms           0
building_id       13
latitude           0
longitude          0
manager_id         0
price             32
interest_level     0
dtype: int64
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>building_id</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>53a5b119ba8f7b61d4e010512e0dfc85</td>
      <td>3000.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c5c8a357cba207596b04d1afd1e4f130</td>
      <td>5465.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c3ba40552e2120b0acfc3cb5730bb2aa</td>
      <td>2850.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>28d9ad350afeaab8027513a3e52ac8d5</td>
      <td>3275.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NaN</td>
      <td>3350.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Impute-missing-data">
<a class="anchor" href="#Impute-missing-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Impute missing data<a class="anchor-link" href="#Impute-missing-data"> </a>
</h3>
<p>You've found that <code>"price"</code> and <code>"building_id"</code> columns have missing values in the Rental Listing Inquiries dataset. So, before passing the data to the models you need to impute these values.</p>
<p>Numerical feature <code>"price"</code> will be encoded with a mean value of non-missing prices.</p>
<p>Imputing categorical feature <code>"building_id"</code> with the most frequent category is a bad idea, because it would mean that all the apartments with a missing <code>"building_id"</code> are located in the most popular building. The better idea is to impute it with a new category.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>

<span class="c1"># Create mean imputer</span>
<span class="n">mean_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">'mean'</span><span class="p">)</span>

<span class="c1"># Price imputation</span>
<span class="n">twosigma</span><span class="p">[[</span><span class="s1">'price'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mean_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">twosigma</span><span class="p">[[</span><span class="s1">'price'</span><span class="p">]])</span>

<span class="c1"># Create constant inputer</span>
<span class="n">constant_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">'constant'</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">'MISSING'</span><span class="p">)</span>

<span class="c1"># building_id imputation</span>
<span class="n">twosigma</span><span class="p">[[</span><span class="s1">'building_id'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">constant_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">twosigma</span><span class="p">[[</span><span class="s1">'building_id'</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">twosigma</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>id                0
bathrooms         0
bedrooms          0
building_id       0
latitude          0
longitude         0
manager_id        0
price             0
interest_level    0
dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="goodboychan/chans_jupyter"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/chans_jupyter/python/datacamp/kaggle/machine_learning/2020/08/12/03-Feature-Engineering.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/chans_jupyter/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/chans_jupyter/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/chans_jupyter/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An easy to use blogging platform with support for Jupyter Notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/goodboychan" title="goodboychan"><svg class="svg-icon grey"><use xlink:href="/chans_jupyter/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/chanseokk" title="chanseokk"><svg class="svg-icon grey"><use xlink:href="/chans_jupyter/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/fastdotai" title="fastdotai"><svg class="svg-icon grey"><use xlink:href="/chans_jupyter/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
